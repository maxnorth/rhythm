// Order fulfillment workflow with inventory checks and shipping logic
// Demonstrates numeric comparisons and complex boolean logic

workflow(ctx, inputs) {
  // Check inventory availability
  let inventory = await task("check_inventory", {
    productId: inputs.productId,
    quantity: inputs.quantity
  })

  if (inventory.available >= inputs.quantity) {
    // Reserve inventory
    await task("reserve_inventory", {
      productId: inputs.productId,
      quantity: inputs.quantity,
      orderId: inputs.orderId
    })

    // Process payment
    let payment = await task("process_payment", {
      orderId: inputs.orderId,
      amount: inputs.totalAmount
    })

    if (payment.status == "success") {
      // Determine shipping method based on order value and urgency
      if (inputs.totalAmount > 500 || inputs.isUrgent == true) {
        await task("schedule_express_shipping", {
          orderId: inputs.orderId,
          address: inputs.shippingAddress
        })
      } else {
        if (inputs.totalAmount > 100) {
          await task("schedule_priority_shipping", {
            orderId: inputs.orderId,
            address: inputs.shippingAddress
          })
        } else {
          await task("schedule_standard_shipping", {
            orderId: inputs.orderId,
            address: inputs.shippingAddress
          })
        }
      }

      // Send confirmation
      await task("send_order_confirmation", {
        email: inputs.customerEmail,
        orderId: inputs.orderId
      })

      // Update loyalty points if customer is a member
      if (inputs.customerId != null) {
        let points = await task("calculate_loyalty_points", {
          amount: inputs.totalAmount
        })
        await task("add_loyalty_points", {
          customerId: inputs.customerId,
          points: points.amount
        })
      }
    } else {
      // Payment failed - release inventory and notify customer
      await task("release_inventory", {
        productId: inputs.productId,
        quantity: inputs.quantity
      })
      await task("send_payment_failure_email", {
        email: inputs.customerEmail,
        reason: payment.errorMessage
      })
    }
  } else {
    // Insufficient inventory
    if (inventory.nextAvailableDate != null) {
      await task("offer_backorder", {
        email: inputs.customerEmail,
        productId: inputs.productId,
        availableDate: inventory.nextAvailableDate
      })
    } else {
      await task("suggest_alternatives", {
        email: inputs.customerEmail,
        productId: inputs.productId
      })
    }
  }

  // Analytics
  task("track_order_event", {
    orderId: inputs.orderId,
    status: inventory.available >= inputs.quantity ? "fulfilled" : "out_of_stock"
  })
}
