name: Test Quickstart

on:
  workflow_call:
    inputs:
      install_from:
        description: 'Install from "local" build or "pypi"'
        required: true
        type: string
      version:
        description: 'Version to install from PyPI (only used when install_from=pypi)'
        required: false
        type: string
        default: ""

jobs:
  test:
    name: Test on ${{ matrix.platform.os }} (${{ matrix.platform.target }})
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux only (Docker Compose not available on macOS/Windows runners)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Start Postgres with Docker Compose
        working-directory: python/examples/quickstart
        run: docker compose up -d
        shell: bash

      - name: Wait for Postgres
        run: |
          timeout 30 bash -c 'until docker exec $(docker ps -q -f name=postgres) pg_isready -U rhythm; do sleep 1; done'
        shell: bash

      - name: Install Rust (for local build)
        if: inputs.install_from == 'local'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Install from local build
        if: inputs.install_from == 'local'
        working-directory: python
        run: |
          pip install -e .
        shell: bash

      - name: Install from PyPI
        if: inputs.install_from == 'pypi'
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            pip install rhythm-async==${{ inputs.version }}
          else
            pip install rhythm-async
          fi
        shell: bash

      - name: Start worker in background
        working-directory: python/examples/quickstart
        env:
          RHYTHM_DATABASE_URL: postgresql://rhythm@localhost/rhythm
        run: |
          python worker.py &
          echo $! > worker.pid
          # Wait for worker to initialize
          sleep 5
        shell: bash

      - name: Run quickstart app
        working-directory: python/examples/quickstart
        env:
          RHYTHM_DATABASE_URL: postgresql://rhythm@localhost/rhythm
        run: python app.py
        shell: bash

      - name: Stop worker
        if: always()
        working-directory: python/examples/quickstart
        run: |
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) || true
          fi
        shell: bash

      - name: Stop Postgres
        if: always()
        working-directory: python/examples/quickstart
        run: docker compose down
        shell: bash
